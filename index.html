<!DOCTYPE html>
<html class='no-js'>
    <head>
        <meta charset='utf-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
        <title>Game of Life</title>
        <meta name='description' content=''>
        <meta name='viewport' content='width=device-width'>

        <link rel='stylesheet' href='css/normalize.min.css'>
        <link rel='stylesheet' href='css/main.css'>

        <script src='js/vendor/modernizr-2.6.2.min.js'></script>
        <script src='js/vendor/jquery-2.0.3.js'></script>
        <script src='js/vendor/gl-matrix.js'></script>
    </head>
    <body>

        <canvas id='canvas'></canvas>

        <script id='vertexShader' type='x-shader/x-vertex'>
            attribute vec2 a_position;


            void main() {
                vec2 clipSpace = a_position * 2.0 - 1.0;
               
                gl_Position = vec4(clipSpace, 0, 1);
            }
        </script>
        
        <script id='fragmentShader' type='x-shader/x-fragment'>
            precision mediump float;

            uniform vec2 u_resolution;
            uniform vec2 u_mouse;
            uniform sampler2D u_buffer;

            #define COLOR vec4(1, 1, 1, 1)
            #define BACKGROUND vec4(0, 0, 0, 1)

            int isColored(int x, int y) {
                if (texture2D(u_buffer, (gl_FragCoord.xy + vec2(x, y)) / u_resolution) == COLOR) 
                    return 1;
                else 
                    return 0;
            }

            void main() {

                vec2 distance = gl_FragCoord.xy - u_mouse;
                       
                float radius = u_resolution.y / 3.;

                if( dot(distance, distance) < radius ){
                    gl_FragColor = COLOR;
                }

                else {
                    int neighborhood = isColored(0, 1)
                                     + isColored(1, 1)
                                     + isColored(1, 0)
                                     + isColored(1, -1)
                                     + isColored(0, -1)
                                     + isColored(-1, -1)
                                     + isColored(-1, 0)
                                     + isColored(-1, 1);

                    //alive
                    if (isColored(0, 0) == 1) {
                        if (neighborhood < 2 || neighborhood > 3)
                            gl_FragColor = texture2D(u_buffer, gl_FragCoord.xy / u_resolution) - vec4(0.008, 0.05, 0.02, 0);
                        else
                            gl_FragColor = COLOR;
                    }

                    //dead
                    else {
                        if (neighborhood == 3)
                           gl_FragColor = COLOR;
                        else
                            gl_FragColor = texture2D(u_buffer, gl_FragCoord.xy / u_resolution) - vec4(0.008, 0.05, 0.02, 0);
                    }
                }
            }
        </script>

        <script id='screenShader' type='x-shader/x-fragment'>
            precision mediump float;

            uniform vec2 u_resolution;
            uniform vec2 u_mouse;
            uniform sampler2D u_screenBuffer;

            void main() {
                vec2 uv = gl_FragCoord.xy / u_resolution;
                gl_FragColor = texture2D(u_screenBuffer, uv);

            }
        </script>

        <script>

        $(document).ready(main);

        function main(){
            var gl;
            var frontBuffer, backBuffer;
            var mainProgram, screenProgram;
            mousePos = {}

            init();
            animate();
        }

        function init(){
            var canvas =  $('canvas');
            gl = canvas[0].getContext('webgl');

            frontBuffer = createBuffer();
            backBuffer = createBuffer();

            // initialize main program
            mainProgram = createProgram('#vertexShader', '#fragmentShader');
            
            // create a plane which fills the screen
            var locVertexCoords = gl.getAttribLocation(mainProgram, 'a_position');
            gl.enableVertexAttribArray(locVertexCoords);
            gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
            gl.vertexAttribPointer(locVertexCoords, 2, gl.FLOAT, false, 0, 0);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
                0, 0,
                0, 1,
                1, 1,
                1, 0]), gl.STATIC_DRAW);

            mainProgram.loc['resolution'] = gl.getUniformLocation(mainProgram, 'u_resolution');
            mainProgram.loc['mouse'] = gl.getUniformLocation(mainProgram, 'u_mouse');
            mainProgram.loc['texture'] = gl.getUniformLocation(mainProgram, 'u_buffer');

            // initialize screen program
            screenProgram = createProgram('#vertexShader', '#screenShader');

            screenProgram.loc['resolution'] = gl.getUniformLocation(screenProgram, 'u_resolution');
            screenProgram.loc['mouse'] = gl.getUniformLocation(screenProgram, 'u_mouse');
            screenProgram.loc['texture'] = gl.getUniformLocation(screenProgram, 'u_screenBuffer');


            // event listeners
            $(window).resize(function(){
                canvas.prop('height', $(window).height());
                canvas.prop('width', $(window).width());

                gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);
                
                frontBuffer = createBuffer();
                backBuffer = createBuffer();
            });
            $(window).trigger('resize');


            canvas.mousemove(function(event) {
                mousePos.x = event.pageX;
                mousePos.y = canvas.height() - event.pageY;
            });

        }

        function drawScene(){

            gl.clear(gl.COLOR_BUFFER_BIT);
            // front buffer
            gl.useProgram(mainProgram);
            gl.bindFramebuffer(gl.FRAMEBUFFER, frontBuffer);
            
            gl.activeTexture(gl.TEXTURE0);
            gl.bindTexture(gl.TEXTURE_2D, backBuffer.texture);

            gl.uniform2f(mainProgram.loc['mouse'], mousePos.x, mousePos.y);
            gl.uniform2f(mainProgram.loc['resolution'], gl.drawingBufferWidth, gl.drawingBufferHeight);
            gl.uniform1i(mainProgram.loc['texture'], 0);

            gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);

            // screen buffer
            gl.useProgram(screenProgram);
            gl.bindFramebuffer(gl.FRAMEBUFFER, null);

            gl.activeTexture(gl.TEXTURE1);
            gl.bindTexture(gl.TEXTURE_2D, frontBuffer.texture);

            gl.uniform2f(screenProgram.loc['mouse'], mousePos.x, mousePos.y);
            gl.uniform2f(screenProgram.loc['resolution'], gl.drawingBufferWidth, gl.drawingBufferHeight);
            gl.uniform1i(screenProgram.loc['texture'], 1);


            gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);

            // swap buffers
            var tmp = frontBuffer;
            frontBuffer = backBuffer;
            backBuffer = tmp;
        }

        function createBuffer(){
            var texture = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, $(window).width(), $(window).height(), 0, gl.RGBA, gl.UNSIGNED_BYTE, null);

            var buffer = gl.createFramebuffer();
            gl.bindFramebuffer(gl.FRAMEBUFFER, buffer);
            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);
            gl.bindFramebuffer(gl.FRAMEBUFFER, null);

            buffer.texture = texture;

            return buffer;

        }

        function createProgram(vertexShaderID, fragmentShaderID){
            var vertexShader = gl.createShader(gl.VERTEX_SHADER);
            gl.shaderSource(vertexShader, $(vertexShaderID).text());
            gl.compileShader(vertexShader);

            var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(fragmentShader, $(fragmentShaderID).text());
            gl.compileShader(fragmentShader);

            var program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);

            program.loc = [];

            return program;
        }

        function animate() {
            drawScene();
            window.requestAnimationFrame(animate);
        }

        </script>
    </body>
</html>
