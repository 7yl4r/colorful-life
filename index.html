<!DOCTYPE html>
<html class='no-js'>
    <head>
        <meta charset='utf-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
        <title>Life</title>
        <meta name='description' content=''>
        <meta name='viewport' content='width=device-width'>

        <link rel='stylesheet' href='css/normalize.min.css'>
        <link rel='stylesheet' href='css/main.css'>

        <script src='js/vendor/jquery-2.1.0.min.js'></script>
        <script src='js/vendor/jquery.mousewheel.js'></script>
        <script src="js/vendor/dat.gui.min.js"></script>
        <script src='js/vendor/stats.js'></script>
    </head>
    <body>

        <canvas id='canvas' oncontextmenu="return false;"></canvas>

        <script id='vertex-shader' type='x-shader/x-vertex'>
            attribute vec2 a_position;

            varying vec2 v_texCoord;


            void main() {
                vec2 clipSpace = a_position * 2.0 - 1.0;
               
                gl_Position = vec4(clipSpace, 0, 1);

                v_texCoord = a_position;
            }
        </script>
        
        <script id='cell-iteration-shader' type='x-shader/x-fragment'>
            precision mediump float;

            uniform vec2 u_bufferResolution;
            uniform vec4 u_surface;
            uniform sampler2D u_buffer;

            varying vec2 v_texCoord;

            #define COLOR vec4(1.0)
            #define BACKGROUND vec4(0.0)
            #define DECAY vec4(1, 0.03, 0.002, 1)

            int isAlive(int x, int y) {

                vec2 onePixel = vec2(1.0, 1.0) / u_bufferResolution;
                if (texture2D(u_buffer, fract(v_texCoord + vec2(x, y) * onePixel)).a > 0.) 
                    return 1;
                else 
                    return 0;
            }

            void main() {

                int n = isAlive(0, 1)
                      + isAlive(1, 1)
                      + isAlive(1, 0)
                      + isAlive(1, -1)
                      + isAlive(0, -1)
                      + isAlive(-1, -1)
                      + isAlive(-1, 0)
                      + isAlive(-1, 1);

                // alive
                if (isAlive(0, 0) == 1) {
                    if (n == 2 || n == 3)
                        gl_FragColor = COLOR;
                    else
                        gl_FragColor = texture2D(u_buffer, v_texCoord) - DECAY;

                }

                // dead
                else {
                    if (n == 3 || n == 7)
                        gl_FragColor = COLOR;
                    else
                        gl_FragColor = texture2D(u_buffer, v_texCoord) - DECAY;
                }
            }
        </script>

        <script id='mouse-shader' type='x-shader/x-fragment'>
            precision mediump float;

            uniform vec2 u_bufferResolution;
            uniform vec2 u_mouse;
            uniform float u_paintSize;
            uniform vec4 u_surface;
            uniform sampler2D u_buffer;

            varying vec2 v_texCoord;

            #define COLOR vec4(1.0)

            float rand(vec2 co) {
                return fract(sin(dot(co.xy, vec2(12.9898,78.233))) * 43758.5453);
            }

            void main() {

                vec2 mouseSector = fract(u_surface.wz + u_mouse * (u_surface.yx - u_surface.wz));
                    
                vec2 distance = abs(mouseSector - v_texCoord);
                distance = min(distance, 1. - distance);
                distance.x *= u_bufferResolution.x / u_bufferResolution.y;

                if ( dot(distance, distance) < u_paintSize )
                    gl_FragColor = COLOR * floor(rand(gl_FragCoord.xy) * 2.);
                else
                    gl_FragColor = texture2D(u_buffer, v_texCoord);
            }

        </script>

        <script id='screen-shader' type='x-shader/x-fragment'>
            precision mediump float;

            uniform sampler2D u_screenBuffer;
            uniform vec4 u_surface; //top, right, bottom left

            varying vec2 v_texCoord;

            void main() {

                vec2 uv = u_surface.wz + v_texCoord * (u_surface.yx - u_surface.wz);
                gl_FragColor = texture2D(u_screenBuffer, fract(uv));
            }

        </script>

        <script src='js/main.js'></script>
    </body>
</html>
